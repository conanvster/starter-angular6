<mat-tab-group [selectedIndex]="1">
  <mat-tab [disabled]="true">
    <ng-template mat-tab-label>
      <button mat-button color="primary" type="button" (click)="addVisit()" [disabled]="hasActiveVisits()">
        <mat-icon>add</mat-icon>
      </button>
    </ng-template>
  </mat-tab>
  <mat-tab *ngFor="let visit of visits.controls; let i=index" [formGroup]="visit">
    <ng-template mat-tab-label>
      <div class="label">{{visit.get('general').get('date').value | date}}</div>
      <mat-icon class="notification-icon"
                *ngIf="visit.invalid"
                color="warn">warning
      </mat-icon>
      <button mat-icon-button
              (click)="$event.stopPropagation()"
              color="primary"
              type="button"
              [matMenuTriggerFor]="menu">
        <mat-icon>arrow_drop_down</mat-icon>
      </button>
      <mat-menu #menu="matMenu" [overlapTrigger]="false">
        <button mat-menu-item (click)="removeVisit(i)">Remove</button>
        <div *ngIf="!visit.get('closed').value; else menuButtonsForNotActiveVisit">
          <button mat-menu-item (click)="closeVisit(i, closed.REJECTED)">Close with rejection</button>
          <button mat-menu-item (click)="closeVisit(i, closed.HIRED)">Close with hire</button>
        </div>
        <ng-template #menuButtonsForNotActiveVisit>
          <button mat-menu-item (click)="reopenVisit(i)">Reopen</button>
        </ng-template>
      </mat-menu>
    </ng-template>
    <div formGroupName="general">
      <div class="row">
        <div class="col-lg-12">
          <h2>General visit info</h2>
        </div>
        <div class="col-lg-3">
          <mat-form-field>
            <input matInput [matDatepicker]="datePicker" placeholder="Date of CV"
                   formControlName="date">
            <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
            <mat-datepicker #datePicker [startView]="'multi-year'"></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="col-lg-3">
          <mat-form-field>
            <mat-select placeholder="Agency" formControlName="_agency">
              <mat-option>--</mat-option>
              <mat-option *ngFor="let agency of agencies" [value]="agency._id">
                {{agency.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-lg-3">
          <mat-form-field>
            <input matInput placeholder="Company (last position)" formControlName="company">
          </mat-form-field>
        </div>
        <div class="col-lg-3">
          <mat-form-field>
            <input matInput type="number" placeholder="Desired salary" formControlName="desiredSalary">
          </mat-form-field>
        </div>
        <div class="col-lg-4">
          <mat-form-field>
            <mat-select placeholder="Position" formControlName="_position">
              <mat-option>--</mat-option>
              <mat-option *ngFor="let position of positions" [value]="position._id">
                {{position.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-lg-4">
          <mat-form-field>
            <mat-select placeholder="How candidate learned about us?" formControlName="_origin">
              <mat-option>--</mat-option>
              <mat-option *ngFor="let origin of origins" [value]="origin._id">
                {{origin.name}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-lg-4 rating-block">
          <span>Overall impression</span>
          <mat-slider [max]="5" [min]="0" [step]="1" formControlName="rating" color="primary"></mat-slider>
          <div class="slide-score">{{visit.get(['general']).get(['rating']).value}} / 5</div>
        </div>
        <div class="col-lg-12">
          <mat-form-field>
            <textarea matInput placeholder="Notes" formControlName="notes" rows="3"></textarea>
          </mat-form-field>
        </div>
      </div>
    </div>
    <div class="row slide-content" formGroupName="skype">
      <div class="col-lg-12">
        <mat-slide-toggle color="primary" formControlName="planned">
          <h2>Skype interview</h2>
        </mat-slide-toggle>
      </div>
      <div class="col-lg-12" *ngIf="visit.get(['skype']).get(['planned']).value">
        <div class="row mat-elevation-z4">
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput [matDatepicker]="dateSkypePicker"
                     placeholder="Date"
                     formControlName="dateTime">
              <mat-datepicker-toggle matSuffix [for]="dateSkypePicker"></mat-datepicker-toggle>
              <mat-datepicker #dateSkypePicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="time" placeholder="Time" formControlName="time">
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="number" placeholder="Overall impression" max="5" formControlName="rating">
              <mat-hint align="end">{{visit.get(['skype']).get(['rating']).value}} / 5</mat-hint>
            </mat-form-field>
          </div>
          <div class="col-lg-12">
            <mat-form-field>
              <textarea matInput placeholder="Notes" formControlName="notes" rows="3"></textarea>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>
    <div class="row slide-content" formGroupName="office">
      <div class="col-lg-12">
        <mat-slide-toggle color="primary" formControlName="planned">
          <h2>Office interview</h2>
        </mat-slide-toggle>
      </div>
      <div class="col-lg-12" *ngIf="visit.get(['office']).get(['planned']).value">
        <div class="row mat-elevation-z4">
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput [matDatepicker]="dateOfficePicker"
                     placeholder="Date"
                     formControlName="dateTime">
              <mat-datepicker-toggle matSuffix [for]="dateOfficePicker"></mat-datepicker-toggle>
              <mat-datepicker #dateOfficePicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="time" placeholder="Time" formControlName="time">
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="number" placeholder="Overall impression" max="5" formControlName="rating">
              <mat-hint align="end">{{visit.get(['office']).get(['rating']).value}} / 5</mat-hint>
            </mat-form-field>
          </div>
          <div class="col-lg-12">
            <mat-form-field>
              <textarea matInput placeholder="Notes" formControlName="notes" rows="3"></textarea>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>
    <div class="row slide-content" formGroupName="proposal">
      <div class="col-lg-12">
        <mat-slide-toggle color="primary" formControlName="done">
          <h2>Proposal</h2>
        </mat-slide-toggle>
      </div>
      <div class="col-lg-12" *ngIf="visit.get(['proposal']).get(['done']).value">
        <div class="row mat-elevation-z4">
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput [matDatepicker]="dateProposalPicker"
                     placeholder="Date Of Proposal"
                     formControlName="date">
              <mat-datepicker-toggle matSuffix [for]="dateProposalPicker"></mat-datepicker-toggle>
              <mat-datepicker #dateProposalPicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="number" placeholder="Salary For Probation"
                     formControlName="probationSalary">
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <input matInput type="number" placeholder="Salary" formControlName="salary">
            </mat-form-field>
          </div>
          <div class="col-lg-3">
            <mat-form-field>
              <mat-select placeholder="Probation Period Duration" formControlName="probationDuration">
                <mat-option *ngFor="let period of periods; let i = index" [value]="i + 1">{{period}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col-lg-12">
            <mat-form-field>
              <textarea matInput placeholder="Notes" formControlName="notes" rows="3"></textarea>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>
  </mat-tab>
</mat-tab-group>
